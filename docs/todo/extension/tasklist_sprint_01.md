# Task List: Sub-Sprint 1 - Dependency Injection & Centralized Config

**Goal:** To refactor all core services to use constructor-based dependency injection and to receive configuration from a centralized source, improving testability and maintainability.

| Task ID | Status | Task Description (Sequential & Atomic Steps) | File(s) To Modify |
| :--- | :--- | :--- | :--- |
| **1.1** | ☐ To Do | **Create `ConfigService.ts`:** Create the file `src/configService.ts`. Implement a class that reads all extension settings from `vscode.workspace.getConfiguration('code-context-engine')` in its constructor and stores them in private properties with public getter methods for each configuration item (e.g., `getQdrantConnectionString()`, `getOllamaConfig()`, `getOpenAIConfig()`). | `src/configService.ts` (New) |
| **1.2** | ☐ To Do | **Refactor `QdrantService` Constructor:** Open `src/db/qdrantService.ts`. Modify the constructor to accept `connectionString: string` as a parameter. Remove any direct calls to `vscode.workspace.getConfiguration()` within this service. | `src/db/qdrantService.ts` |
| **1.3** | ☐ To Do | **Refactor `OllamaProvider` Constructor:** Open `src/embeddings/ollamaProvider.ts`. Modify the constructor to accept a `config: OllamaConfig` object as a parameter. Define the `OllamaConfig` interface if it doesn't exist. Remove any direct calls to `vscode.workspace.getConfiguration()` within this service. | `src/embeddings/ollamaProvider.ts` |
| **1.4** | ☐ To Do | **Refactor `OpenAIProvider` Constructor:** Open `src/embeddings/openaiProvider.ts`. Modify the constructor to accept a `config: OpenAIConfig` object as a parameter. Define the `OpenAIConfig` interface if it doesn't exist. Remove any direct calls to `vscode.workspace.getConfiguration()` within this service. | `src/embeddings/openaiProvider.ts` |
| **1.5** | ☐ To Do | **Update `EmbeddingProviderFactory`:** Open `src/embeddings/embeddingProvider.ts` (or wherever your factory is located). Modify the factory function/class to accept an instance of `ConfigService`. Use the `ConfigService` to retrieve the appropriate configuration (e.g., `configService.getOllamaConfig()`) and pass it to the `OllamaProvider` or `OpenAIProvider` constructor when creating an instance. | `src/embeddings/embeddingProvider.ts` |
| **1.6** | ☐ To Do | **Refactor `ContextService` Constructor:** Open `src/context/contextService.ts`. Modify the constructor to accept `qdrantService: QdrantService` and `embeddingProvider: IEmbeddingProvider` as parameters. Remove any `new` keyword usages for these dependencies within the constructor. | `src/context/contextService.ts` |
| **1.7** | ☐ To Do | **Refactor `IndexingService` Constructor:** Open `src/indexing/indexingService.ts`. Modify the constructor to accept all its dependencies (`fileWalker`, `astParser`, `chunker`, `qdrantService`, `embeddingProvider`, `lspService`, and `configService` if needed) as parameters. Remove any `new` keyword usages for these dependencies within the constructor. | `src/indexing/indexingService.ts` |
| **1.8** | ☐ To Do | **Create Test Mocks File:** Create a new file `src/test/mocks.ts`. Implement mock classes or objects for `QdrantService`, `IEmbeddingProvider`, `FileWalker`, `AstParser`, `Chunker`, and `LspService` that can be used in unit tests. These mocks should implement the necessary methods that the services under test will call. | `src/test/mocks.ts` (New) |
| **1.9** | ☐ To Do | **Update `ContextService` Unit Tests:** Open `src/test/contextService.test.ts`. Modify existing unit tests to instantiate `ContextService` with the newly created mock dependencies (e.g., `new ContextService(new MockQdrantService(), new MockEmbeddingProvider())`). Add new tests to verify `ContextService` logic using these mocks, ensuring it does not rely on the actual VS Code API. | `src/test/contextService.test.ts` |
| **1.10** | ☐ To Do | **Update `IndexingService` Unit Tests:** Open `src/test/indexingService.test.ts` (if it exists, otherwise create it). Modify existing unit tests or create new ones to instantiate `IndexingService` with the newly created mock dependencies. Verify `IndexingService` logic using these mocks. | `src/test/indexingService.test.ts` (New/Modify) |
| **1.11** | ☐ To Do | **Update `extension.ts` for Initial Wiring:** Open `src/extension.ts`. In the `activate` function, instantiate `ConfigService`. Then, use the `ConfigService` instance to retrieve configuration values and pass them to the constructors of `QdrantService`, `OllamaProvider`, `OpenAIProvider`, `ContextService`, and `IndexingService` during their instantiation. Ensure all services are correctly wired together. | `src/extension.ts` |
